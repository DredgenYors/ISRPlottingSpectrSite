<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live ISR Spectra Plot</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        /* ============================================================================
           FONTS AND BASE STYLES
        ============================================================================ */
        body {
            font-family: "San Francisco Pro", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        /* ============================================================================
           LEFT PANEL LAYOUT AND STYLING
        ============================================================================ */
        .left-panel {
            width: 25%;
            background: #f4f4f4;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            direction: rtl; /* Move scrollbar to left */
            border-right: none;
            position: relative;
            font-family: inherit;
            overflow-x: hidden;
        }

        .left-panel * {
            direction: ltr; /* Content remains left-to-right */
        }

        /* Custom Scrollbar Styling */
        .left-panel::-webkit-scrollbar {
            width: 10px;
        }

        .left-panel::-webkit-scrollbar-track {
            background: linear-gradient(to left, rgba(0,0,0,0.08) 0%, #f4f4f4 40%, #f4f4f4 100%);
            border-radius: 5px;
        }

        .left-panel::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            border: 2px solid #f4f4f4;
        }

        .left-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Shadow Effects for Panel Separation */
        .left-panel::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to left, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.01) 40%, rgba(0,0,0,0.001) 100%);
            z-index: 2;
        }

        /* ============================================================================
           RIGHT PANEL LAYOUT AND STYLING
        ============================================================================ */
        .right-panel {
            width: 75%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: inherit;
            position: relative;
            background: #f9f9f6;
        }

        .right-panel::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 12px;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to right, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.01) 40%, rgba(0,0,0,0.001) 100%);
            z-index: 2;
        }

        /* ============================================================================
           PLOT WINDOW STYLING
        ============================================================================ */
        .plot-window {
            width: 90%;
            height: 90%;
            max-width: 1000px;
            max-height: 800px;
            border: 1px solid #ccc;
        }

        .plot-data {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .plot-data.visible {
            opacity: 1;
        }

        /* ============================================================================
           BUTTON STYLING AND LAYOUT
        ============================================================================ */
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        /* Base Button Styles */
        .button {
            padding: 10px 20px;
            font-size: 1.1em;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12), 0 1.5px 4px rgba(0,0,0,0.08);
            background-image: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, rgba(0,0,0,0.06) 100%);
        }

        .button:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.12);
            background-image: linear-gradient(180deg, rgba(255,255,255,0.18) 0%, rgba(0,0,0,0.10) 100%);
        }

        /* Generate Plot Button */
        .generate-btn {
            background-color: #007BFF;
            color: white;
        }
        .generate-btn:hover {
            background-color: #0056B3;
        }

        /* Reset Button */
        .reset-btn {
            background-color: #DC3545;
            color: white;
        }
        .reset-btn:hover {
            background-color: #A71D2A;
        }

        /* Ion Line Button */
        .ion-line-btn {
            background-color: #28A745;
            color: white;
        }
        .ion-line-btn:hover {
            background-color: #218838;
        }

        /* Toggle Scale Button */
        .toggle-scale-btn {
            background-color: #17A2B8;
            color: white;
        }
        .toggle-scale-btn:hover {
            background-color: #117A8B;
        }

        /* Matrix/Plot Selection Buttons */
        .matrix-button {
            width: 100px;
            height: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            background-color: #6c757d;
            transition: background-color 0.3s;
            margin-bottom: 5px;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12), 0 1.5px 4px rgba(0,0,0,0.08);
        }

        .matrix-button:hover {
            background-color: #5a6268;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.12);
        }

        .blue-button {
            background-color: #20C997 !important;
        }
        .blue-button:hover {
            background-color: #198754 !important;
        }

        /* Toggle Visibility Buttons */
        .toggle-button {
            padding: 5px 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            background-color: #B8860B;
            transition: background-color 0.3s;
            margin-left: 5px;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12), 0 1.5px 4px rgba(0,0,0,0.08);
        }

        .toggle-button:hover {
            background-color: #8B7500;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.12);
        }

        /* Region Buttons */
        .region-btn {
            margin-left: 5px;
            color: white;
            font-weight: bold;
        }

        /* ============================================================================
           FORM CONTROLS AND INPUT STYLING
        ============================================================================ */
        .input-container {
            margin-bottom: 5px;
        }

        input[type="text"] {
            width: 80%;
            padding: 8px 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus {
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            outline: none;
        }

        /* ============================================================================
           PARAMETER SECTIONS STYLING
        ============================================================================ */
        .param-section {
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 2px 6px rgba(0,0,0,0.10), 0 1px 2px rgba(0,0,0,0.08);
        }

        .parameters-heading {
            font-size: 1.3em;
            text-shadow: 0 2px 6px rgba(0,0,0,0.10), 0 1px 2px rgba(0,0,0,0.08);
        }

        .param-subheading {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            text-align: center;
            text-shadow: 0 1.5px 4px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
        }

        .param-subsection {
            margin-bottom: 15px;
        }

        .param-container, .input-container div, input {
            font-family: inherit;
        }

        .input-container > div {
            text-shadow: 0 1px 3px rgba(0,0,0,0.10);
        }

        /* ============================================================================
           ION SPECIES GRID LAYOUT
        ============================================================================ */
        .ion-grid {
            display: grid;
            justify-items: start;
            text-align: left;
            margin-left: 0;
            grid-template-columns: 0.75fr 0.4fr 0.4fr;
            gap: 2px;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }

        .ion-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
            padding: 0;
        }

        .ion-cell label {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }

        .ion-cell input {
            width: 100%;
            padding: 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }

        .ion-cell input:focus {
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            outline: none;
        }

        .ion-total {
            grid-column: span 2;
            font-size: 1em;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        #ion-percentage-total {
            display: block;
            width: 100%;
            text-align: center;
            margin: 0 auto 10px auto;
            font-weight: bold;
        }

        /* ============================================================================
           MESSAGE OVERLAYS AND LOADING STATES
        ============================================================================ */
        .error-message {
            display: none;
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: #fff0f0;
            color: #d8000c;
            font-size: 1.1em;
            font-weight: bold;
            padding: 12px 30px;
            border: 2px solid #d8000c;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            max-width: 90vw;
            width: max-content;
            min-width: 200px;
            text-align: center;
            pointer-events: none;
        }

        .loading-message {
            opacity: 0;
            transition: opacity 1s ease;
            display: block;
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 1000;
        }

        .loading-message.visible {
            opacity: 1;
        }

        /* Welcome Message */
        .welcome-message {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            background: none;
            color: #000;
            padding: 0;
            border-radius: 0;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
        }

        .welcome-message.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Center Loading Messages */
        .center-loading-message,
        .center-loading-message.secondary-message {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            background: none;
            color: #000;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 2s ease;
            width: 100%;
            max-width: 600px;
        }

        .center-loading-message {
            top: 46%;
        }

        .center-loading-message.secondary-message {
            top: 53%;
        }

        .center-loading-message.visible,
        .center-loading-message.secondary-message.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* ============================================================================
           TOOLTIPS
        ============================================================================ */
        button[data-tooltip] {
            position: relative;
        }

        button[data-tooltip]::after {
            content: attr(data-tooltip);
            visibility: hidden;
            opacity: 0;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 6px 12px;
            position: absolute;
            z-index: 1;
            top: 50%;
            left: 100%;
            transform: translateY(-50%) translateX(10px);
            font-size: 0.95em;
            font-weight: normal;
            white-space: nowrap;
            display: block;
            box-sizing: border-box;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            pointer-events: none;
            min-width: max-content;
            right: auto;
            bottom: auto;
        }

        button[data-tooltip]::before {
            content: '';
            position: absolute;
            top: 50%;
            left: calc(100% + 2px);
            transform: translateY(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent transparent #333;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        button[data-tooltip]:hover::after,
        button[data-tooltip]:hover::before {
            visibility: visible;
            opacity: 1;
        }

        button[data-tooltip].tooltip-align-left::after {
            left: 0;
            transform: none;
        }

        /* ============================================================================
           ANIMATIONS
        ============================================================================ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            opacity: 0;
            animation: fadeIn 0.8s forwards;
        }

        .fade-in-delayed {
            opacity: 0;
            animation: fadeIn 0.8s forwards;
            animation-delay: 0.6s;
        }

        /* ============================================================================
           RESPONSIVE DESIGN
        ============================================================================ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .left-panel {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid black;
            }
            .right-panel {
                width: 100%;
                height: auto;
            }
            .plot-window {
                width: 100%;
                height: 300px;
            }
            .button-container {
                flex-wrap: wrap;
                justify-content: center;
            }
            .matrix-button, .toggle-button {
                width: 45%;
                margin: 5px auto;
            }
            .ion-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (min-width: 1200px) {
            .left-panel {
                width: 20%;
            }
            .right-panel {
                width: 80%;
            }
            .plot-window {
                width: 95%;
                height: 95%;
            }
        }

        @media (max-width: 480px) {
            .left-panel {
                width: 100%;
                padding: 5px;
            }
            .right-panel {
                width: 100%;
            }
            .plot-window {
                height: 250px;
            }
            .button-container {
                flex-direction: column;
                gap: 5px;
            }
            .matrix-button, .toggle-button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- ============================================================================
         ERROR MESSAGE DISPLAY
    ============================================================================ -->
    <span id="error-message" class="error-message">Error: Something went wrong!</span>
    
    <!-- ============================================================================
         LEFT PANEL - CONTROLS AND PARAMETERS
    ============================================================================ -->
    <div class="left-panel">
        <!-- Main Action Buttons -->
        <div class="button-container">
            <button class="button generate-btn" data-tooltip="Generate Selected Plot">Generate Plot</button>
            <button class="button reset-btn" onclick="resetValues()" data-tooltip="Reset all parameter values">Reset</button>
            <button class="button ion-line-btn" onclick="zoomToIonLine()" data-tooltip="Focus on center">Ion Line</button>
        </div>

        <!-- Plot Selection Controls -->
        <div class="profile-row">
            <div>
                <button class="matrix-button blue-button">Plot 1</button>
                <button class="toggle-button" onclick="toggleVisibility(0)" data-tooltip="Toggle Visibility">Toggle Plot 1</button>
            </div>
            <div>
                <button class="matrix-button">Plot 2</button>
                <button class="toggle-button" onclick="toggleVisibility(1)" data-tooltip="Toggle Visibility">Toggle Plot 2</button>
            </div>
            <div>
                <button class="matrix-button">Plot 3</button>
                <button class="toggle-button" onclick="toggleVisibility(2)" data-tooltip="Toggle Visibility">Toggle Plot 3</button>
            </div>
        </div>

        <!-- Plot Control Buttons -->
        <div class="button-container">
            <button class="button toggle-scale-btn" onclick="toggleScale()" data-tooltip="Toggle Logarithmic/Linear">Toggle Scale</button>
            <button class="button region-btn" style="background-color: #800080;" onclick="setERegion()" data-tooltip="Fill All Parameter Values">E-Region</button>
            <button class="button region-btn" style="background-color: #a020f0;" onclick="setFRegion()" data-tooltip="Fill All Parameter Values">F-Region</button>
        </div>

        <!-- Parameter Input Sections -->
        <div class="param-section parameters-heading">Parameters</div>
        <div class="param-container" id="variable-params">
            <!-- Basic Parameters -->
            <div class="param-subsection">
                <div class="param-subheading">Basic</div>
                <div class="input-container">
                    <div>Radar Frequency [Hz]</div>
                    <input type="text" id="frequency" value="430e6">
                </div>
                <div class="input-container">
                    <div>Scattering Angle [°]</div>
                    <input type="text" id="theta" value="60">
                </div>
                <div class="input-container">
                    <div>Electron Density [m⁻³]</div>
                    <input type="text" id="ne" value="2.0e11">
                </div>
                <div class="input-container">
                    <div>Electron Temperature [K]</div>
                    <input type="text" id="Te" value="500">
                </div>
                <div class="input-container">
                    <div>Ion Temperature [K]</div>
                    <input type="text" id="Ti" value="500">
                </div>
            </div>
            
            <!-- Advanced Parameters -->
            <div class="param-subsection">
                <div class="param-subheading">Advanced</div>
                <div class="input-container">
                    <div>Ion Collision Frequency [Hz]</div>
                    <input type="text" id="nu_i" value="1.0e-7">
                </div>
                <div class="input-container">
                    <div>Electron Collision Frequency [Hz]</div>
                    <input type="text" id="nu_e" value="1.0e-7">
                </div>
                <div class="input-container">
                    <div>Ion Mass [kg]</div>
                    <input type="text" id="mi" value="2.65686e-26">
                </div>
                <div class="input-container">
                    <div>Electron Mass [kg]</div>
                    <input type="text" id="me" value="9.11e-31">
                </div>
                <div class="input-container">
                    <div>Magnetic Field [T]</div>
                    <input type="text" id="B" value="3.6e-5">
                </div>
                <div class="input-container">
                    <div>N Terms [unitless] <i style="font-size: smaller;">odd values will center the plot at 0, large values will increase the plot generation time, small n values may distort the generated plot</i></div>
                    <input type="text" id="n_terms" value="2001">
                </div>
            </div>
        </div>

        <!-- Ion Species Configuration -->
        <div class="param-section">Ion Species Fractions & Densities</div>
        <div class="param-container ion-grid">
            <!-- Total Ion Percentage Display -->
            <div class="ion-total" id="ion-percentage-total" style="grid-column: span 3; text-align: center;">
                Total Ion Percentage: 100%
            </div>
            
            <!-- Grid Headers -->
            <div class="ion-cell" style="font-weight: bold; text-align: center;">Ion</div>
            <div class="ion-cell" style="font-weight: bold; text-align: center;">Density [m⁻³]</div>
            <div class="ion-cell" style="font-weight: bold; text-align: center;">Fraction (%)</div>
            
            <!-- Ion Species Rows -->
            <div class="ion-cell" style="text-align: center;">
                <label for="Oplus_density">O<sup>+</sup></label>
            </div>
            <div class="ion-cell">
                <input type="text" id="Oplus_density" value="2.03e5">
            </div>
            <div class="ion-cell">
                <input type="text" id="Oplus_fraction" value="48.8" oninput="updateIonPercentageTotal()">
            </div>
            
            <div class="ion-cell" style="text-align: center;">
                <label for="Nplus_density">N<sup>+</sup></label>
            </div>
            <div class="ion-cell">
                <input type="text" id="Nplus_density" value="1.33e4">
            </div>
            <div class="ion-cell">
                <input type="text" id="Nplus_fraction" value="3.2" oninput="updateIonPercentageTotal()">
            </div>
            
            <div class="ion-cell" style="text-align: center;">
                <label for="Hplus_density">H<sup>+</sup></label>
            </div>
            <div class="ion-cell">
                <input type="text" id="Hplus_density" value="1.89e5">
            </div>
            <div class="ion-cell">
                <input type="text" id="Hplus_fraction" value="45.6" oninput="updateIonPercentageTotal()">
            </div>
            
            <div class="ion-cell" style="text-align: center;">
                <label for="Heplus_density">He<sup>+</sup></label>
            </div>
            <div class="ion-cell">
                <input type="text" id="Heplus_density" value="9.96e3">
            </div>
            <div class="ion-cell">
                <input type="text" id="Heplus_fraction" value="2.4" oninput="updateIonPercentageTotal()">
            </div>
            
            <div class="ion-cell" style="text-align: center;">
                <label for="O2plus_density">O<sub>2</sub><sup>+</sup></label>
            </div>
            <div class="ion-cell">
                <input type="text" id="O2plus_density" value="0">
            </div>
            <div class="ion-cell">
                <input type="text" id="O2plus_fraction" value="0" oninput="updateIonPercentageTotal()">
            </div>
            
            <div class="ion-cell" style="text-align: center;">
                <label for="NOplus_density">NO<sup>+</sup></label>
            </div>
            <div class="ion-cell">
                <input type="text" id="NOplus_density" value="0">
            </div>
            <div class="ion-cell">
                <input type="text" id="NOplus_fraction" value="0" oninput="updateIonPercentageTotal()">
            </div>
        </div>
    </div>

    <!-- ============================================================================
         RIGHT PANEL - PLOT DISPLAY AND MESSAGES
    ============================================================================ -->
    <div class="right-panel">
        <!-- Loading Message -->
        <div id="loading-message" class="loading-message">Generating plot, please wait...</div>
        
        <!-- Welcome Message -->
        <div id="welcome-message" class="welcome-message">
            Welcome! Click "Generate Plot" to begin.
        </div>

        <!-- Center Loading Messages -->
        <div id="center-loading-message" class="center-loading-message">
            Change the parameters to create different spectra.
        </div>
        <div id="center-loading-message-2" class="center-loading-message secondary-message">
            Use the buttons to create multiple plots at once and focus on specific features. 
        </div>

        <!-- Plot Display Area -->
        <div id="plot" class="plot-window plot-data"></div>
    </div>

    <script>
        /* ============================================================================
           GLOBAL VARIABLES AND STATE MANAGEMENT
        ============================================================================ */
        let currentLoadingMessage = "Generating plot, please wait.";
        let centerMessagesFadedOnce = false;
        let loadingInterval = null;
        let loadingDots = 0;
        let defaultParamsSnapshot = null;
        let selectedProfile = "Plot1";
        let plotData = [];
        let visibility = { "Plot1": true, "Plot2": true, "Plot3": true };
        let firstPlotGenerated = false;
        let isLogScale = true;

        // Loading message configuration
        const loadingPhrases = [
            "Generating plot, please wait.",
            "Sending parameters to server",
            "Calculating spectra",
            "Rendering plot"
        ];
        let loadingPhraseIndex = 0;
        let loadingPhraseTimer = null;
        let loadingCycleDuration = 2000;

        /* ============================================================================
           INITIALIZATION AND PAGE LOAD HANDLERS
        ============================================================================ */
        window.addEventListener('DOMContentLoaded', function() {
            // Snapshot default parameters for comparison
            defaultParamsSnapshot = getCurrentParams();
            
            // Initialize fade-in animations
            document.querySelectorAll('.button-container, .profile-row').forEach(el => {
                el.classList.add('fade-in');
            });
            document.querySelectorAll('.param-section, .param-container').forEach(el => {
                el.classList.add('fade-in-delayed');
            });

            // Show welcome message after delay
            const welcomeMsg = document.getElementById("welcome-message");
            setTimeout(() => {
                welcomeMsg.classList.add("visible");
            }, 1750);

            // Load default profile data
            fetch('/get_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: "Plot1" })
            })
            .then(response => response.json())
            .then(data => {
                for (let key in data) {
                    if (document.getElementById(key)) {
                        document.getElementById(key).value = data[key];
                    }
                }
            })
            .catch(error => {
                console.error("Error loading default profile data:", error);
                alert("Error loading default profile data. Please refresh the page and try again.");
            });
        });

        /* ============================================================================
           PARAMETER MANAGEMENT FUNCTIONS
        ============================================================================ */
        function getCurrentParams() {
            let params = {};
            document.querySelectorAll("input").forEach(input => {
                params[input.id] = input.value;
            });
            return params;
        }

        function paramsAreDefault(current, defaults) {
            for (let key in defaults) {
                if (current[key] !== defaults[key]) return false;
            }
            return true;
        }

        function updateIonPercentageTotal() {
            const ionPercentages = [
                parseFloat(document.getElementById("Oplus_fraction").value) || 0,
                parseFloat(document.getElementById("Nplus_fraction").value) || 0,
                parseFloat(document.getElementById("Hplus_fraction").value) || 0,
                parseFloat(document.getElementById("Heplus_fraction").value) || 0,
                parseFloat(document.getElementById("O2plus_fraction").value) || 0,
                parseFloat(document.getElementById("NOplus_fraction").value) || 0
            ];

            const totalPercentage = ionPercentages.reduce((sum, value) => sum + value, 0);
            const totalElement = document.getElementById("ion-percentage-total");
            totalElement.textContent = `Total Ion Percentage: ${totalPercentage.toFixed(2)}%`;

            if (totalPercentage > 100) {
                totalElement.style.color = "red";
            } else {
                totalElement.style.color = "#333";
            }
        }

        /* ============================================================================
           PROFILE AND BUTTON MANAGEMENT
        ============================================================================ */
        const buttons = document.querySelectorAll(".matrix-button");
        buttons.forEach(button => {
            button.addEventListener("click", function () {
                buttons.forEach(btn => btn.classList.remove("blue-button"));
                this.classList.add("blue-button");

                if (this.textContent.includes("1")) {
                    selectedProfile = "Plot1";
                } else if (this.textContent.includes("2")) {
                    selectedProfile = "Plot2";
                } else if (this.textContent.includes("3")) {
                    selectedProfile = "Plot3";
                }

                console.log(`Profile ${selectedProfile} selected, updating input fields.`);

                fetch('/get_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile: selectedProfile })
                })
                .then(response => response.json())
                .then(data => {
                    for (let key in data) {
                        if (document.getElementById(key)) {
                            document.getElementById(key).value = data[key];
                        }
                    }
                })
                .catch(error => {
                    console.error("Error fetching profile data:", error);
                    alert(`Error fetching data for Profile ${selectedProfile}. Please try again.`);
                });
            });
        });

        /* ============================================================================
           LOADING MESSAGE MANAGEMENT
        ============================================================================ */
        function startLoadingMessage(message, delayedByCenterMessages = false) {
            const loadingMessage = document.getElementById("loading-message");
            loadingPhraseIndex = 0;
            loadingMessage.classList.add("visible");

            loadingCycleDuration = delayedByCenterMessages ? 2000 : 10000;

            function cyclePhrases() {
                if (loadingPhraseIndex < loadingPhrases.length - 1) {
                    loadingMessage.textContent = loadingPhrases[loadingPhraseIndex];
                    loadingPhraseIndex++;
                    loadingPhraseTimer = setTimeout(cyclePhrases, loadingCycleDuration / loadingPhrases.length);
                } else {
                    loadingMessage.textContent = loadingPhrases[loadingPhrases.length - 1];
                }
            }

            cyclePhrases();
            loadingDots = 0;
            loadingInterval = setInterval(() => {
                loadingDots = (loadingDots + 1) % 4;
                loadingMessage.textContent += ".".repeat(loadingDots);
            }, 500);
        }

        function stopLoadingMessage() {
            const loadingMessage = document.getElementById("loading-message");
            clearInterval(loadingInterval);
            clearTimeout(loadingPhraseTimer);
            loadingMessage.classList.remove("visible");
        }

        function updateLoadingMessage(message) {
            currentLoadingMessage = message;
            const loadingMessage = document.getElementById("loading-message");
            loadingMessage.textContent = currentLoadingMessage + ".".repeat(loadingDots);
        }

        /* ============================================================================
           CENTER MESSAGE MANAGEMENT
        ============================================================================ */
        function showCenterLoadingMessage() {
            document.getElementById("center-loading-message").classList.add("visible");
            setTimeout(() => {
                document.getElementById("center-loading-message-2").classList.add("visible");
            }, 1200);

            if (window.centerMsgTimeout) clearTimeout(window.centerMsgTimeout);
            window.centerMsgTimeout = setTimeout(() => {
                hideCenterLoadingMessage();
            }, 30000);
        }

        function hideCenterLoadingMessage() {
            const msg1 = document.getElementById("center-loading-message");
            const msg2 = document.getElementById("center-loading-message-2");
            msg1.classList.remove("visible");
            msg2.classList.remove("visible");
            if (window.centerMsgTimeout) clearTimeout(window.centerMsgTimeout);

            setTimeout(() => {
                centerMessagesFadedOnce = true;
                maybeShowLoadingMessage();
            }, 2000);
        }

        function maybeShowLoadingMessage() {
            const loadingMessage = document.getElementById("loading-message");
            const plotElement = document.getElementById("plot");
            if (plotElement.classList.contains("visible")) {
                loadingMessage.classList.remove("visible");
                return;
            }
            if (centerMessagesFadedOnce) {
                startLoadingMessage("Calculating spectra");
            }
        }

        function hideWelcomeMessage() {
            const welcomeMsg = document.getElementById("welcome-message");
            if (welcomeMsg && welcomeMsg.classList.contains("visible")) {
                welcomeMsg.classList.remove("visible");
            }
        }

        /* ============================================================================
           PLOT GENERATION AND MANAGEMENT
        ============================================================================ */
        function generatePlot() {
            hideWelcomeMessage();
            const errorMessage = document.getElementById("error-message");
            const plotElement = document.getElementById("plot");
            errorMessage.style.display = "none";

            // Validate ion percentage
            const totalPercentage = parseFloat(document.getElementById("ion-percentage-total").textContent.replace("Total Ion Percentage: ", "").replace("%", ""));
            if (totalPercentage > 100) {
                stopLoadingMessage();
                hideCenterLoadingMessage();
                errorMessage.textContent = "Ion percentage exceeds 100%, please edit the values and try again.";
                errorMessage.style.display = "inline";
                return;
            }

            let newValues = {};

            // Build ion species array
            updateLoadingMessage("Collecting ion species parameters");
            const ion_species = [
                {
                    name: "O+",
                    fraction: parseFloat(document.getElementById("Oplus_fraction").value) / 100,
                    density: parseFloat(document.getElementById("Oplus_density").value),
                    mass: 2.65686e-26
                },
                {
                    name: "N+",
                    fraction: parseFloat(document.getElementById("Nplus_fraction").value) / 100,
                    density: parseFloat(document.getElementById("Nplus_density").value),
                    mass: 2.32587e-26
                },
                {
                    name: "H+",
                    fraction: parseFloat(document.getElementById("Hplus_fraction").value) / 100,
                    density: parseFloat(document.getElementById("Hplus_density").value),
                    mass: 1.67262e-27
                },
                {
                    name: "HE+",
                    fraction: parseFloat(document.getElementById("Heplus_fraction").value) / 100,
                    density: parseFloat(document.getElementById("Heplus_density").value),
                    mass: 6.64648e-27
                },
                {
                    name: "O2+",
                    fraction: parseFloat(document.getElementById("O2plus_fraction").value) / 100,
                    density: parseFloat(document.getElementById("O2plus_density").value),
                    mass: 5.31372e-26
                },
                {
                    name: "NO+",
                    fraction: parseFloat(document.getElementById("NOplus_fraction").value) / 100,
                    density: parseFloat(document.getElementById("NOplus_density").value),
                    mass: 2.4828e-26
                }
            ];
            newValues["ion_species"] = ion_species;

            // Collect all other input values
            document.querySelectorAll("input").forEach(input => {
                newValues[input.id] = parseFloat(input.value);
            });

            // Show appropriate loading messages
            setTimeout(() => {
                if (!firstPlotGenerated && paramsAreDefault(getCurrentParams(), defaultParamsSnapshot)) {
                    showCenterLoadingMessage();
                } else {
                    startLoadingMessage("Calculating spectra");
                }
            }, 1000);

            // Send data to server and generate plot
            updateLoadingMessage("Sending parameters to server");
            fetch('/update_values', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newValues)
            })
            .then(() => {
                updateLoadingMessage("Calculating spectra");
                return fetch('/plot');
            })
            .then(response => response.json())
            .then(data => {
                updateLoadingMessage("Rendering plot");
                let colors = { "Plot 1": "blue", "Plot 2": "red", "Plot 3": "green" };
                let currentProfile = selectedProfile;
                let trace = {
                    x: data.frequencies,
                    y: data.spectra,
                    mode: 'lines',
                    name: currentProfile,
                    line: { color: colors[currentProfile] },
                    visible: visibility[currentProfile] ? true : "legendonly"
                };

                let existingTraceIndex = plotData.findIndex(t => t.name === currentProfile);
                if (existingTraceIndex !== -1) {
                    plotData[existingTraceIndex] = trace;
                } else {
                    plotData.push(trace);
                }

                let layout = {
                    title: 'Backscatter Spectra',
                    xaxis: { title: 'Frequency (MHz)' },
                    yaxis: { title: 'Spectra', type: 'log' },
                    hovermode: 'x unified',
                    autosize: true
                };

                Plotly.newPlot('plot', plotData, layout, { responsive: true });
                plotElement.classList.add('visible');
                stopLoadingMessage();
                hideCenterLoadingMessage();
                firstPlotGenerated = true;
            })
            .catch(error => {
                stopLoadingMessage();
                document.getElementById("loading-message").style.opacity = "0";
                hideCenterLoadingMessage();
                errorMessage.textContent = `Error generating plot. Please check your inputs and try again.`;
                errorMessage.style.display = "inline";
            });
        }

        /* ============================================================================
           PLOT CONTROL FUNCTIONS
        ============================================================================ */
        function toggleVisibility(profileIndex) {
            const profileNames = ["Plot1", "Plot2", "Plot3"];
            const profileName = profileNames[profileIndex];

            const traceIndex = plotData.findIndex(t => t.name === profileName);
            if (traceIndex !== -1) {
                plotData[traceIndex].visible = plotData[traceIndex].visible === true ? 'legendonly' : true;

                const layout = {
                    title: 'Backscatter Spectra',
                    xaxis: { title: 'Frequency (MHz)' },
                    yaxis: { title: 'Spectra', type: 'log' },
                    hovermode: 'x unified',
                    autosize: true
                };

                Plotly.react('plot', plotData, layout, { responsive: true });
            } else {
                console.warn(`No plot data found for profile: ${profileName}. Generate the plot first.`);
                alert(`No plot data found for ${profileName}. Please generate the plot first.`);
            }
        }

        function toggleScale() {
            const layout = {
                title: 'Backscatter Spectra',
                xaxis: { title: 'Frequency (MHz)' },
                yaxis: {
                    title: 'Spectra',
                    type: isLogScale ? 'linear' : 'log'
                },
                hovermode: 'x unified',
                autosize: true
            };

            Plotly.react('plot', plotData, layout, { responsive: true });
            isLogScale = !isLogScale;
            console.log(`Y-axis scale toggled to: ${isLogScale ? 'logarithmic' : 'linear'}`);
        }

        function zoomToIonLine() {
            if (!plotData || plotData.length === 0) {
                console.error("No plot data available to zoom into the ion line.");
                alert("Please generate the plot first before zooming into the ion line.");
                return;
            }

            const ionLineXRange = [-0.05, 0.05];
            const ionLineYRange = [10e-9, 10e-6];

            Plotly.relayout('plot', {
                'xaxis.range': ionLineXRange,
                'yaxis.type': 'log',
                'yaxis.range': [Math.log10(ionLineYRange[0]), Math.log10(ionLineYRange[1])]
            });

            console.log("Zoomed in on the ion line with y-axis range:", ionLineYRange);
        }

        /* ============================================================================
           PRESET CONFIGURATION FUNCTIONS
        ============================================================================ */
        function resetValues() {
            const defaultIonSpecies = [
                { fraction: 48.8, density: 2.03e5 },
                { fraction: 3.2,  density: 1.33e4 },
                { fraction: 45.6, density: 1.89e5 },
                { fraction: 2.4,  density: 9.96e3 },
                { fraction: 0,    density: 0 },
                { fraction: 0,    density: 0 }
            ];

            document.getElementById("Oplus_fraction").value = defaultIonSpecies[0].fraction;
            document.getElementById("Oplus_density").value   = defaultIonSpecies[0].density;
            document.getElementById("Nplus_fraction").value  = defaultIonSpecies[1].fraction;
            document.getElementById("Nplus_density").value   = defaultIonSpecies[1].density;
            document.getElementById("Hplus_fraction").value  = defaultIonSpecies[2].fraction;
            document.getElementById("Hplus_density").value   = defaultIonSpecies[2].density;
            document.getElementById("Heplus_fraction").value = defaultIonSpecies[3].fraction;
            document.getElementById("Heplus_density").value  = defaultIonSpecies[3].density;
            document.getElementById("O2plus_fraction").value = defaultIonSpecies[4].fraction;
            document.getElementById("O2plus_density").value  = defaultIonSpecies[4].density;
            document.getElementById("NOplus_fraction").value = defaultIonSpecies[5].fraction;
            document.getElementById("NOplus_density").value  = defaultIonSpecies[5].density;
            
            const profileData = {
                "Plot1": {
                    nu_i: "1.0e-7", nu_e: "1.0e-7", ni: "2.0e11", ne: "2.0e11",
                    theta: "60", Te: "500", Ti: "500", frequency: "430e6",
                    n_terms: "2001", mi: "2.65686e-26", me: "9.11e-31", B: "3.6e-5",
                    epsilon_0: "8.854187817e-12", kB: "1.380649e-23", e: "1.602e-19"
                }
            };
            
            let selectedProfile = "Plot1";
            const profile = profileData[selectedProfile];
            for (let key in profile) {
                if (document.getElementById(key)) {
                    document.getElementById(key).value = profile[key];
                }
            }
        }

        function setERegion() {
            document.getElementById("Ti").value = 1143;
            document.getElementById("Te").value = 1454;
            document.getElementById("Oplus_fraction").value = 97.4;
            document.getElementById("Nplus_fraction").value = 1.8;
            document.getElementById("Hplus_fraction").value = 0.7;
            document.getElementById("Heplus_fraction").value = 0.1;
            document.getElementById("O2plus_fraction").value = 0;
            document.getElementById("NOplus_fraction").value = 0;
            document.getElementById("Oplus_density").value = 6.88e6;
            document.getElementById("Nplus_density").value = 1.27e5;
            document.getElementById("Hplus_density").value = 4.94e4;
            document.getElementById("Heplus_density").value = 7.06e3;
            document.getElementById("O2plus_density").value = 0;
            document.getElementById("NOplus_density").value = 0;
        }

        function setFRegion() {
            document.getElementById("Ti").value = 3675;
            document.getElementById("Te").value = 3675;
            document.getElementById("Oplus_fraction").value = 8.1;
            document.getElementById("Nplus_fraction").value = 1.6;
            document.getElementById("Hplus_fraction").value = 85.0;
            document.getElementById("Heplus_fraction").value = 5.2;
            document.getElementById("O2plus_fraction").value = 0;
            document.getElementById("NOplus_fraction").value = 0;
            document.getElementById("Oplus_density").value = 1.02e4;
            document.getElementById("Nplus_density").value = 2.01e3;
            document.getElementById("Hplus_density").value = 1.07e5;
            document.getElementById("Heplus_density").value = 6.52e3;
            document.getElementById("O2plus_density").value = 0;
            document.getElementById("NOplus_density").value = 0;
        }

        /* ============================================================================
           TOOLTIP MANAGEMENT
        ============================================================================ */
        document.querySelectorAll('button[data-tooltip]').forEach(button => {
            button.addEventListener('mouseenter', function() {
                button.classList.remove('tooltip-align-left');
                const tooltipText = button.getAttribute('data-tooltip');
                const tempTooltip = document.createElement('div');
                tempTooltip.style.position = 'absolute';
                tempTooltip.style.visibility = 'hidden';
                tempTooltip.style.whiteSpace = 'nowrap';
                tempTooltip.style.fontSize = '0.95em';
                tempTooltip.style.fontWeight = 'normal';
                tempTooltip.style.padding = '6px 12px';
                tempTooltip.textContent = tooltipText;
                document.body.appendChild(tempTooltip);
                const tooltipWidth = tempTooltip.offsetWidth;
                document.body.removeChild(tempTooltip);

                const buttonRect = button.getBoundingClientRect();
                const tooltipLeft = buttonRect.left + buttonRect.width / 2 - tooltipWidth / 2;
                if (tooltipLeft < 0) {
                    button.classList.add('tooltip-align-left');
                }
            });
            button.addEventListener('mouseleave', function() {
                button.classList.remove('tooltip-align-left');
            });
        });

        /* ============================================================================
           EVENT LISTENERS
        ============================================================================ */
        document.querySelector(".generate-btn").addEventListener("click", generatePlot);
    </script>
</body>
</html>
