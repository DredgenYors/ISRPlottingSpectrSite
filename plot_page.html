<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live ISR Spectra Plot</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
        }
        .left-panel {
            width: 25%;
            background: #f4f4f4;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        .right-panel {
            width: 75%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .plot-window {
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 600px;
            border: 1px solid #ccc;
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .button {
            padding: 10px 20px;
            font-size: 1.1em;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .generate-btn {
            background-color: #007BFF;
        }
        .generate-btn:hover {
            background-color: #0056b3;
        }
        .reset-btn {
            background-color: #DC3545;
        }
        .reset-btn:hover {
            background-color: #a71d2a;
        }
        .input-container {
            margin-bottom: 10px;
        }
        .error-message {
            color: red;
            font-weight: bold;
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="button-container">
            <button class="button generate-btn" onclick="generatePlot()">Generate Plot</button>
            <button class="button reset-btn" onclick="resetValues()">Reset</button>
            <p class="error-message" id="error-message"></p>
        </div>

        <!-- Upper Section: Non-Constant Parameters -->
        <div class="param-section">Variable Parameters</div>
        <div class="param-container" id="variable-params">
            <div class="input-container">
                <div>Ion Collision Frequency [Hz]</div>
                <input type="text" id="nu_i" value="1.0e-7">
            </div>

            <div class="input-container">
                <div>Electron Collision Frequency [Hz]</div>
                <input type="text" id="nu_e" value="1.0e-7">
            </div>

            <div class="input-container">
                <div>Ion Density [m⁻³]</div>
                <input type="text" id="ni" value="2.0e11">
            </div>

            <div class="input-container">
                <div>Electron Density [m⁻³]</div>
                <input type="text" id="ne" value="2.0e11">
            </div>

            <div class="input-container">
                <div>Scattering Angle [°]</div>
                <input type="text" id="theta" value="60">
            </div>

            <div class="input-container">
                <div>Electron Temperature [K]</div>
                <input type="text" id="Te" value="500">
            </div>

            <div class="input-container">
                <div>N Terms [unitless]</div>
                <input type="text" id="n_terms" value="2000">
            </div>
        </div>

        <!-- Lower Section: Constant Parameters -->
        <div class="param-section">Constant Parameters</div>
        <div class="param-container" id="constant-params">
            <div class="input-container">
                <div>Ion Mass [kg]</div>
                <input type="text" id="mi" value="2.65686e-26">
            </div>

            <div class="input-container">
                <div>Electron Mass [kg]</div>
                <input type="text" id="me" value="9.11e-31">
            </div>

            <div class="input-container">
                <div>Magnetic Field [T]</div>
                <input type="text" id="B" value="3.6e-5">
            </div>

            <div class="input-container">
                <div>Vacuum Permittivity [F/m]</div>
                <input type="text" id="epsilon_0" value="8.854187817e-12">
            </div>

            <div class="input-container">
                <div>Boltzmann Constant [J/K]</div>
                <input type="text" id="kB" value="1.380649e-23">
            </div>

            <div class="input-container">
                <div>Elementary Charge [C]</div>
                <input type="text" id="e" value="1.602e-19">
            </div>
        </div>
    </div>
    <div class="right-panel">
        <div id="plot" class="plot-window"></div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (typeof Plotly === 'undefined') {
                console.error("Plotly failed to load.");
            } else {
                generatePlot();
            }
        });

        function generatePlot() {
            let newValues = {};
            document.querySelectorAll("input").forEach(input => {
                newValues[input.id] = parseFloat(input.value);
            });

            fetch('/update_values', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newValues)
            })
            .then(response => response.json())
            .then(() => fetch('/plot'))
            .then(response => response.json())
            .then(data => {
                console.log("Received Data:", data);
                if (!data.frequencies || !data.spectra) {
                    throw new Error("Missing data for plot");
                }
                
                let trace = {
                    x: data.frequencies,
                    y: data.spectra,
                    mode: 'lines',
                    name: 'ISR Spectra'
                };
                let layout = {
                    title: 'ISR Spectra for Different Electron Temperatures',
                    xaxis: { title: 'Frequency (MHz)' },
                    yaxis: { title: 'Spectra', type: 'log' },
                    hovermode: 'x unified',
                    autosize: true
                };
                Plotly.newPlot('plot', [trace], layout, { responsive: true });

                // Hide error message if plot generation is successful
                document.getElementById("error-message").style.display = "none";
            })
            .catch(error => {
                console.error("Error generating plot:", error);
        
                // Display error message to user
                let errorMessage = document.getElementById("error-message");
                errorMessage.textContent = "An error occurred while generating the plot. Resetting to default values...";
                errorMessage.style.display = "block";

                // Automatically reset values and try again
                setTimeout(() => {
                    resetValues();
                }, 500); // Add a short delay before resetting
            });
        }

        function resetValues() {
            document.querySelectorAll("input").forEach(input => {
                input.value = input.defaultValue;
            });
            generatePlot();
        }
    </script>
</body>
</html>

